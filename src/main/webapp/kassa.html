<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Jeans & Lifestyle - Artikel aanmaken</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="assets/css/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="dashboard.css" rel="stylesheet">
	
	<link href="css/bootstrap.icon-large.min.css" rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="assets/js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="hoofdpagina.html">Jeans & Lifestyle</a>
        </div>
       
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-3 col-md-2 sidebar">
            <div id="sidebar" class="well sidebar-nav">
                 <h5><i class="glyphicon glyphicon-home"></i>
                    <small><b>MANAGEMENT</b></small>
                </h5>
                <ul class="nav nav-pills nav-stacked">
                    <li><a href="hoofdpagina.html">Home</a></li>
                    <li class="active"><a href="kassa.html">Kassa</a></li>
                    <li><a href="klanten.html">Klanten</a></li>
					<li><a href="voorraad.html">Voorraad</a></li>
					<li><a href="verkopen.html">Verkopen</a></li>
                </ul>
                <h5><i class="glyphicon glyphicon-log-out"></i>
                    <a href="#"><span id="logout">Uitloggen</span></a>
                </h5>
            </div>
        </div>
		
        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
          <h1 id="VerkoopRegelAanmakenH1" class="page-header">Verkoop invoeren</h1>
          <div class='expendable'></div>
		  
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
               <tr>
          <th>VerkoopID: </th>
          <th>Datum:</th>
          <th>Klant Email</th>
          <th>KlantID:</th>
          </tr>
          
          <tr>
          <form id="verkoopInvoeren">
          <td id="NextVerkoopID"><input type="text"class="form-control"  id="IDVI" name='verkoopID' readonly/></td>
          <td id="datumVandaag"><input type="text" class='form-control' id='datumVandaag' name='datumVandaag' readonly/></td>
          <td><select class="form-control" id="klantEmail" ></select></td>
          <td id="klantIDForm"><input type="text" class='form-control' id='klantID'  name='klantID' readonly></td>
          </form>
          </tr>
          
                <tr>
                  <th class="col-xs-2">Gescand artikel</th>
        <th class="col-xs-2">Naam</th>
        <th class="col-xs-2">Categorie</th>
        <th class="col-xs-1">Maat</th>
        <th class="col-xs-1">Kleur</th>
        <th class="col-xs-1">Merk</th>
		<th class="col-xs-1">Aantal</th>
		<th class="col-xs-1">Verkoopprijs</th>
		<th class="col-xs-1"><button type="button" class="btn btn-info" id="regelToevoegen">Regel toevoegen</button></th>
				 <th></th>
                </tr>
              </thead>
              
              <tbody id='verkopenTbody'>
              
              </tbody>
            </table>
            
             <div class="pull-right"> 
   
   <table>
   
 
   
   <tr>
   <td></td>
   <td></td>
   <td><button type="button" class="btn btn-success" id="verkoopregelPost">Verkoop afronden</button></td>
   </tr>
   </table>
          </div>
            
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>
    <script src="js/bootstrap.min.js"></script>
    <!-- Just to make our placeholder images work. Don't actually copy the next line! -->
    <script src="assets/js/vendor/holder.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="assets/js/ie10-viewport-bug-workaround.js"></script>
    
    <script>
    $("#logout").click(function(event){
    	window.sessionStorage.setItem("sessionToken", "guest");
    	window.location.href="index.html";
    })
    
    var d = new Date();
    var month = d.getMonth()+1;
    var day = d.getDate();
    var datumVandaag = ((''+day).length<2?'0' : '') + day + '-' + ((''+month).length<2?'0' : '') + month + '-' + d.getFullYear();
    
    var klantid0 = document.getElementById("klantID");
  //zet standaard klantID op 0 voor wanneer een klant niet zijn/haar naam in het systeem wilt
    setTimeout(function(){ klantid0.value = "0"}, 500); 
    
    
    $("#datumVandaag input:first-child").val(datumVandaag);
    
    $.ajax({
   		url: "restservices/verkopen/nextval",
   		method: "GET",
   		beforeSend: function (xhr) {
   		var token = window.sessionStorage.getItem("sessionToken");
   		xhr.setRequestHeader( 'Authorization', 'Bearer ' + token);
   		},
   		success: function (IDResult) {
   		//zet eerst volgend beschikbare verkoopID in een niet-aanpasbaar inputveld
   			$("#IDVI").val(IDResult.nextverkoopID); 
   	     }
       });
    
    
    $.ajax({
		url: "restservices/klanten/",
		method: "GET",
		beforeSend: function (xhr) {
		var token = window.sessionStorage.getItem("sessionToken");
		xhr.setRequestHeader( 'Authorization', 'Bearer ' + token);
		},
		success: function (klanten) {
			 $.each(klanten, function(i, klant){
				// vul klantemail input met alle klanten emails en IDs
				 $("#klantEmail").append("<option>" + klant.ID + ", " + klant.Email + "</option>"); 
			 })	
	     }
    });
    
  //wanneer klant email veranderd, verander klant ID ook
    $("#klantEmail").change(function(){ 
		var klantID = "";
	
    	$("#klantEmail option:selected").each(function(){
    		klantID += $(this).text().split(', ')[0];
    	});
    	
    	$.get("restservices/klanten/" + klantID, function(data){
    	$("#klantIDForm input:first-child").val(data.ID);
    	})
    }).change();
    
    $.ajax({
   		url: "restservices/verkopen/nextval",
   		method: "GET",
   		beforeSend: function (xhr) {
   		var token = window.sessionStorage.getItem("sessionToken");
   		xhr.setRequestHeader( 'Authorization', 'Bearer ' + token);
   		},
   		success: function (IDResult) {
   			$(".IDVRI").val(IDResult.nextverkoopID);
   	     }
       });
    
    
    var count = 0;
    $(function(){
 	 $("#regelToevoegen").click(function(){
 		count += 1;
 		$("#verkopenTbody").append("<tr>"
 		    +"<form id='verkoopRegelForm"+count+"'>"
 		    +"  <td id='verkoopID_"+count+"' style='display: none;'> <input form='verkoopRegelForm"+ count+"' class='form-control IDVRI' name='VerkoopID' readonly  ></input></td>"
 		    +"	<td id='artikelHiddenID_"+count+"' style='display: none;'> <input  form='verkoopRegelForm"+ count+"'type='text' class='form-control' 	name='ArtikelID'    readonly ></input></td>"
 			+"	<td id='artID_"+count+"'> 			<select class='form-control' id='artikelInputID_"+count+"' name='ArtikelID'><option></option></select></td>"
 			+"	<td id='artNaam_"+count+"'>			<input  class='form-control' readonly value=''></input></td>"
 			+"  <td id='artCategorie_"+count+"'>	<input  class='form-control' readonly value=''></input></td>"
 			+"  <td id='artMaat_"+count+"'> 		<input  form='verkoopRegelForm"+ count+"'class='form-control' name='ArtikelMaat' readonly value=''></input></td>"
 			+"	<td id='artKleur_"+count+"'> 		<input  form='verkoopRegelForm"+ count+"'class='form-control' name='ArtikelKleur' readonly value=''></input></td>"
 			+"	<td id='artMerk_"+count+"'> 		<input  class='form-control' readonly value=''></input></td>"
 			+"	<td id='artAantal_"+count+"'> 		<select form='verkoopRegelForm"+ count+"'class='form-control calcAantal' name='Aantal'>"
 			+"		<option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option>"
 		    +"		<option>9</option><option>10</option><option>11</option><option>12</option><option>13</option><option>14</option><option>15</option><option>16</option><option>17</option>"
 		    +"		<option>18</option><option>19</option><option>20</option><option>21</option><option>22</option><option>23</option><option>24</option><option>25</option><option>26</option>"
 		    +"		<option>27</option><option>28</option><option>29</option><option>30</option><option>31</option><option>32</option><option>33</option><option>34</option>"
 		    +"		<option>35</option><option>36</option><option>37</option><option>38</option><option>39</option><option>40</option></select></td>"
 		    +"	<td id='artVerkoopprijs_"+count+"'><input class='form-control' readonly value=''></input></td>"
 		    +"	<td><button type='button' class='close' aria-label='Close'>"
 		    +"	   <span aria-hidden='true'>&times;</span></button></td>"
 		    +"   </form>"
 		    +"   </tr>"
 		);
 		
 		 $.ajax({
		   		url: "restservices/verkopen/nextval",
		   		method: "GET",
		   		beforeSend: function (xhr) {
		   		var token = window.sessionStorage.getItem("sessionToken");
		   		xhr.setRequestHeader( 'Authorization', 'Bearer ' + token);
		   		},
		   		success: function (IDResult) {
		   		//elke verkoopregel krijgt de verkoopID mee gestuurd
		   			$(".IDVRI").val(IDResult.nextverkoopID); 
		   	     }
		       });
    
    $.ajax({
		url: "restservices/voorraad/",
		method: "GET",
		beforeSend: function (xhr) {
		var token = window.sessionStorage.getItem("sessionToken");
		xhr.setRequestHeader( 'Authorization', 'Bearer ' + token);
		},
		success: function (voorraad) {
			//vul lijst onder 'gescand artikel' met alle artikelen uit de voorraad
			$.each(voorraad, function(i, voorraadArtikel){ 
				$("#artikelInputID_"+count).append("<option>" + voorraadArtikel.ID + ", " + voorraadArtikel.Maat +", " +  voorraadArtikel.Kleur + "</option>");
			})
			}
		});
    
  //wanneer een artikel ID/maat/kleur (gescand artikel) wordt veranderd bij de input, veranderd de rest mee (zie hieronder)
	$("#artikelInputID_"+count).change(function(){ 
		var ID = "";
		var Maat = "";
		var Kleur = "";
		
    	$("#artikelInputID_"+count + " option:selected").each(function(){
    		ID += $(this).text().split(', ')[0];
    		Maat += $(this).text().split(', ')[1];
    		Kleur += $(this).text().split(', ')[2];
    	});
    	
    	//zet data automatisch in de velden
    	$.get("restservices/voorraad/" + ID + "/" + Maat + "/" + Kleur, function(data){ 
    	$("#artikelHiddenID_"+count + " input:first-child").val(data.ID);
    	$("#artNaam_"+count + " input:first-child").val(data.Naam);
    	$("#artCategorie_"+count + " input:first-child").val(data.Categorie);
    	$("#artMaat_"+count +  " input:first-child").val(data.Maat);
    	$("#artKleur_"+count +  " input:first-child").val(data.Kleur);
    	$("#artMerk_"+count +  " input:first-child").val(data.Merk);
    	$("#artVerkoopprijs_"+count + " input:first-child").val(data.Verkoopprijs);
    	
    	if($("#artAantal_"+count).val() > data.Aantal || data.Aantal == 0){
    		alert("Je hebt een groter aantal geselecteerd dan dat er daadwerkelijk aanwezig is in de voorraad!");
    		$(".expendable").replaceWith("<div class='alert alert-warning expendable' id='response'> Let op! Er zijn nog maar <strong>"+data.Aantal+"</strong> stuks aanwezig van artikel: "+data.ID+" "+data.Naam+", maat: '"+data.Maat+"', kleur: "+data.Kleur+".</div>");
    	}
    	})
    }).change();
	
	$(".close").click(function(){
		// verwijder een verkoopregel
		$(this).closest("tr").remove(); 
	});
 	})
    })    
	    
    	
   
    
    function validate(form){
    	var formID = form.id;
    	var formDetails = $('#'+formID);
    
    	if(formID == 'verkoopInvoeren'){
    		$.ajax({
    			url: "restservices/verkopen/",
    			success: function(response){		
        	var data = $("#verkoopInvoeren").serialize();
        	$.post("restservices/verkopen", data, function(response){
        //		$(".expendable").replaceWith("<div class='alert alert-success' id='response'> <strong>Verkoop:</strong> " + response.VerkoopID  + " is toegevoegd!</div>");
        	})		
        	}
        	
        	});
    	}
    	else{
    	
    	$.ajax({
			url: "restservices/verkoopregels/",
			success: function(response){
			
		var data = formDetails.serialize();
    	$.post("restservices/verkoopregels", data, function(response){
    		localStorage.setItem("Expendable",""+response.VerkoopID+"");
    		
    	})	
    	}
    	});
    	}
    }
    
    $("#verkoopregelPost").click(function(){ 
    	// valideer elke form op de pagina (1 verkoopregel = 1 form)
    	for (var i=0, n=document.forms.length; i<n; i++){ 
    		validate(document.forms[i]);
    	}
    	
    	function reloadPage(){
    		location.reload();
    	}
    	setTimeout(reloadPage, 300);
    	
	});
    
    //zorgt ervoor dat nadat de page refresht wordt, er een bericht komt dat de verkoop met success is aangemaakt en maakt daarna de localstorage leeg voor de volgende verkoop
    function storageMessage(){
    if(localStorage.getItem("Expendable")){
    	$(".expendable").replaceWith("<div class='alert alert-success expendable' id='response'> <strong>Verkoop:</strong> " + localStorage.getItem("Expendable") + " is toegevoegd!</div>");
    	localStorage.clear();
    }
    }
    setTimeout(storageMessage, 400);
    
   
    </script>
  </body>
</html>
